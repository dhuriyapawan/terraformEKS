name : CI Pipeline

on :
  push :
     branches: [main, develop]
  pull_request :
     branches: [main, develop]

jobs:
  test: 
    runs-on : ubuntu-latest

    strategy :
      matrix :
        node-version : [14.x, 16.x]
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies
        run : |
         cd app
         npm CI

      - name: Run linting
        run : |
         cd app
         npm run lint
          - name: Run tests
            run : |
             cd app
             npm test
    
          - name : Upload coverage report
            uses : codecov/codecov-action@v3
            with:
              file : ./app/coverage/lcov.info
              flags : unittests
              name : codecov-umbrella
              fail_ci_if_error : false
    
  security-scan:
        runs-on : ubuntu-latest
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v3
    
        - name: Run Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@master
          with:
            scan-type : 'fs'
            scan-ref : '.'
            format : 'sarif'
            output : 'trivy-results.sarif'
        - name: Upload Trivy scan results to GitHub Security tab
          if: always()
          uses: github/codeql-action/upload-sarif@v2
          with:
           sarif_file: trivy-results.sarif
